{
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_failing_lambda_retries_after_visibility_timeout": {
    "recorded-date": "31-08-2022, 06:38:19",
    "recorded-content": {
      "get_destination_queue_url": {
        "QueueUrl": "<queue-url:1>",
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "event_source_mapping": {
        "BatchSize": 1,
        "EventSourceArn": "arn:aws:sqs:<region>:111111111111:<resource:1>",
        "FunctionArn": "arn:aws:lambda:<region>:111111111111:function:<resource:2>",
        "FunctionResponseTypes": [],
        "LastModified": "datetime",
        "MaximumBatchingWindowInSeconds": 0,
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        },
        "State": "Enabled",
        "StateTransitionReason": "USER_INITIATED",
        "UUID": "<uuid:1>"
      },
      "first_attempt": {
        "Messages": [
          {
            "Body": {
              "error": "failed attempt",
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:2>",
                    "receiptHandle": "<receipt-handle:3>",
                    "body": "{\"destination\": \"<queue-url:1>\", \"fail_attempts\": 1}",
                    "attributes": {
                      "ApproximateReceiveCount": "1",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<md5-of-body:1>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MessageId": "<uuid:3>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "second_attempt": {
        "Messages": [
          {
            "Body": {
              "error": null,
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:2>",
                    "receiptHandle": "<receipt-handle:4>",
                    "body": "{\"destination\": \"<queue-url:1>\", \"fail_attempts\": 1}",
                    "attributes": {
                      "ApproximateReceiveCount": "2",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<md5-of-body:1>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:2>",
            "MessageId": "<uuid:4>",
            "ReceiptHandle": "<receipt-handle:2>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_redrive_policy_with_failing_lambda": {
    "recorded-date": "31-08-2022, 06:38:40",
    "recorded-content": {
      "get_destination_queue_url": {
        "QueueUrl": "<queue-url:1>",
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "first_attempt": {
        "Messages": [
          {
            "Body": {
              "error": "failed attempt",
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:4>",
                    "body": "{\"destination\": \"<queue-url:1>\", \"fail_attempts\": 2}",
                    "attributes": {
                      "ApproximateReceiveCount": "1",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<m-d5-of-body:3>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MessageId": "<uuid:2>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "second_attempt": {
        "Messages": [
          {
            "Body": {
              "error": "failed attempt",
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:5>",
                    "body": "{\"destination\": \"<queue-url:1>\", \"fail_attempts\": 2}",
                    "attributes": {
                      "ApproximateReceiveCount": "2",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<m-d5-of-body:3>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:2>",
            "MessageId": "<uuid:3>",
            "ReceiptHandle": "<receipt-handle:2>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "dlq_response": {
        "Messages": [
          {
            "Body": {
              "destination": "<queue-url:1>",
              "fail_attempts": 2
            },
            "MD5OfBody": "<m-d5-of-body:3>",
            "MessageId": "<uuid:1>",
            "ReceiptHandle": "<receipt-handle:3>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_sqs_queue_as_lambda_dead_letter_queue": {
    "recorded-date": "31-08-2022, 06:41:46",
    "recorded-content": {
      "lambda-response-dlq-config": {
        "TargetArn": "arn:aws:sqs:<region>:111111111111:<resource:1>"
      },
      "messages": {
        "Messages": [
          {
            "Body": {
              "raise_error": 1
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MD5OfMessageAttributes": "<md5-hash>",
            "MessageAttributes": {
              "ErrorCode": {
                "DataType": "Number",
                "StringValue": "200"
              },
              "ErrorMessage": {
                "DataType": "String",
                "StringValue": "Test exception (this is intentional)"
              },
              "RequestID": {
                "DataType": "String",
                "StringValue": "<request-id:1>"
              }
            },
            "MessageId": "<uuid:1>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_report_batch_item_failures": {
    "recorded-date": "31-08-2022, 06:42:14",
    "recorded-content": {
      "get_destination_queue_url": {
        "QueueUrl": "<queue-url:1>",
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "send_message_batch": {
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        },
        "Successful": [
          {
            "Id": "message-1",
            "MD5OfMessageBody": "<md5-of-body:1>",
            "MessageId": "<uuid:1>",
            "SequenceNumber": "<sequence-number:1>"
          },
          {
            "Id": "message-2",
            "MD5OfMessageBody": "<md5-of-body:2>",
            "MessageId": "<uuid:2>",
            "SequenceNumber": "<sequence-number:2>"
          },
          {
            "Id": "message-3",
            "MD5OfMessageBody": "<md5-of-body:3>",
            "MessageId": "<uuid:3>",
            "SequenceNumber": "<sequence-number:3>"
          },
          {
            "Id": "message-4",
            "MD5OfMessageBody": "<m-d5-of-body:3>",
            "MessageId": "<uuid:4>",
            "SequenceNumber": "<sequence-number:4>"
          }
        ]
      },
      "create_event_source_mapping": {
        "BatchSize": 10,
        "EventSourceArn": "arn:aws:sqs:<region>:111111111111:<resource:1>",
        "FunctionArn": "arn:aws:lambda:<region>:111111111111:function:<resource:2>",
        "FunctionResponseTypes": [
          "ReportBatchItemFailures"
        ],
        "LastModified": "datetime",
        "MaximumBatchingWindowInSeconds": 0,
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 202
        },
        "State": "Creating",
        "StateTransitionReason": "USER_INITIATED",
        "UUID": "<uuid:5>"
      },
      "first_invocation": {
        "Messages": [
          {
            "Body": {
              "event": {
                "Records": [
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "1",
                      "MessageDeduplicationId": "dedup-1",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:1>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 1,
                      "fail_attempts": 0
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<md5-of-body:1>",
                    "messageAttributes": {},
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:4>"
                  },
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "1",
                      "MessageDeduplicationId": "dedup-2",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:2>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 2,
                      "fail_attempts": 1
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<md5-of-body:2>",
                    "messageAttributes": {},
                    "messageId": "<uuid:2>",
                    "receiptHandle": "<receipt-handle:5>"
                  },
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "1",
                      "MessageDeduplicationId": "dedup-3",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:3>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 3,
                      "fail_attempts": 1
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<md5-of-body:3>",
                    "messageAttributes": {},
                    "messageId": "<uuid:3>",
                    "receiptHandle": "<receipt-handle:6>"
                  },
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "1",
                      "MessageDeduplicationId": "dedup-4",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:4>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 4,
                      "fail_attempts": 2
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<m-d5-of-body:3>",
                    "messageAttributes": {},
                    "messageId": "<uuid:4>",
                    "receiptHandle": "<receipt-handle:7>"
                  }
                ]
              },
              "result": {
                "batchItemFailures": [
                  {
                    "itemIdentifier": "<uuid:2>"
                  },
                  {
                    "itemIdentifier": "<uuid:3>"
                  },
                  {
                    "itemIdentifier": "<uuid:4>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MessageId": "<uuid:6>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "second_invocation": {
        "Messages": [
          {
            "Body": {
              "event": {
                "Records": [
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "2",
                      "MessageDeduplicationId": "dedup-2",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:2>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 2,
                      "fail_attempts": 1
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<md5-of-body:2>",
                    "messageAttributes": {},
                    "messageId": "<uuid:2>",
                    "receiptHandle": "<receipt-handle:8>"
                  },
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "2",
                      "MessageDeduplicationId": "dedup-3",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:3>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 3,
                      "fail_attempts": 1
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<md5-of-body:3>",
                    "messageAttributes": {},
                    "messageId": "<uuid:3>",
                    "receiptHandle": "<receipt-handle:9>"
                  },
                  {
                    "attributes": {
                      "ApproximateFirstReceiveTimestamp": "timestamp",
                      "ApproximateReceiveCount": "2",
                      "MessageDeduplicationId": "dedup-4",
                      "MessageGroupId": "1",
                      "SenderId": "sender-id",
                      "SentTimestamp": "timestamp",
                      "SequenceNumber": "<sequence-number:4>"
                    },
                    "awsRegion": "<region>",
                    "body": {
                      "message": 4,
                      "fail_attempts": 2
                    },
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "md5OfBody": "<m-d5-of-body:3>",
                    "messageAttributes": {},
                    "messageId": "<uuid:4>",
                    "receiptHandle": "<receipt-handle:10>"
                  }
                ]
              },
              "result": {
                "batchItemFailures": [
                  {
                    "itemIdentifier": "<uuid:4>"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:2>",
            "MessageId": "<uuid:7>",
            "ReceiptHandle": "<receipt-handle:2>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "dlq_response": {
        "Messages": [
          {
            "Body": {
              "message": 4,
              "fail_attempts": 2
            },
            "MD5OfBody": "<m-d5-of-body:3>",
            "MessageId": "<uuid:4>",
            "ReceiptHandle": "<receipt-handle:3>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_report_batch_item_failures_on_lambda_error": {
    "recorded-date": "31-08-2022, 09:10:51",
    "recorded-content": {
      "dlq_messages": [
        {
          "MessageId": "<uuid:1>",
          "ReceiptHandle": "<receipt-handle:1>",
          "MD5OfBody": "<m-d5-of-body:1>",
          "Body": "{not a json body"
        },
        {
          "MessageId": "<uuid:2>",
          "ReceiptHandle": "<receipt-handle:2>",
          "MD5OfBody": "<m-d5-of-body:2>",
          "Body": {
            "message": 2,
            "fail_attempts": 0
          }
        }
      ]
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_report_batch_item_failures_invalid_result_json_batch_fails": {
    "recorded-date": "31-08-2022, 06:43:00",
    "recorded-content": {
      "get_destination_queue_url": {
        "QueueUrl": "<queue-url:1>",
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "first_invocation": {
        "Messages": [
          {
            "Body": {
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:4>",
                    "body": "{\"message\": 1, \"fail_attempts\": 0}",
                    "attributes": {
                      "ApproximateReceiveCount": "1",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<m-d5-of-body:3>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              },
              "result": {
                "batchItemFailures": [
                  {
                    "foo": "notvalid"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MessageId": "<uuid:2>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "second_invocation": {
        "Messages": [
          {
            "Body": {
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:5>",
                    "body": "{\"message\": 1, \"fail_attempts\": 0}",
                    "attributes": {
                      "ApproximateReceiveCount": "2",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<m-d5-of-body:3>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              },
              "result": {
                "batchItemFailures": [
                  {
                    "foo": "notvalid"
                  }
                ]
              }
            },
            "MD5OfBody": "<m-d5-of-body:2>",
            "MessageId": "<uuid:3>",
            "ReceiptHandle": "<receipt-handle:2>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "dlq_response": {
        "Messages": [
          {
            "Body": {
              "message": 1,
              "fail_attempts": 0
            },
            "MD5OfBody": "<m-d5-of-body:3>",
            "MessageId": "<uuid:1>",
            "ReceiptHandle": "<receipt-handle:3>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  },
  "tests/integration/awslambda/test_lambda_integration_sqs.py::test_report_batch_item_failures_empty_json_batch_succeeds": {
    "recorded-date": "31-08-2022, 06:43:25",
    "recorded-content": {
      "get_destination_queue_url": {
        "QueueUrl": "<queue-url:1>",
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      },
      "first_invocation": {
        "Messages": [
          {
            "Body": {
              "event": {
                "Records": [
                  {
                    "messageId": "<uuid:1>",
                    "receiptHandle": "<receipt-handle:2>",
                    "body": "{\"message\": 1, \"fail_attempts\": 0}",
                    "attributes": {
                      "ApproximateReceiveCount": "1",
                      "SentTimestamp": "timestamp",
                      "SenderId": "sender-id",
                      "ApproximateFirstReceiveTimestamp": "timestamp"
                    },
                    "messageAttributes": {},
                    "md5OfBody": "<md5-of-body:1>",
                    "eventSource": "aws:sqs",
                    "eventSourceARN": "arn:aws:sqs:<region>:111111111111:<resource:1>",
                    "awsRegion": "<region>"
                  }
                ]
              },
              "result": {}
            },
            "MD5OfBody": "<m-d5-of-body:1>",
            "MessageId": "<uuid:2>",
            "ReceiptHandle": "<receipt-handle:1>"
          }
        ],
        "ResponseMetadata": {
          "HTTPHeaders": {},
          "HTTPStatusCode": 200
        }
      }
    }
  }
}
