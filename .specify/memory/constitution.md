<!--
Sync Impact Report
===================
- Version change: 1.0.0 → 1.1.0
- Modified principles:
  - V. Development Environment — added 5-step LocalStack Lifecycle Management
    subsection (verify stopped, start, verify running, stop, verify stopped)
- Modified sections:
  - Development Workflow — expanded steps 6-11 with lifecycle checks
- Templates requiring updates:
  - .specify/templates/plan-template.md — ✅ compatible (no changes needed)
  - .specify/templates/spec-template.md — ✅ compatible (no changes needed)
  - .specify/templates/tasks-template.md — ✅ compatible (no changes needed)
- Follow-up TODOs: none
-->

# LocalStack Constitution

## Core Principles

### I. Test-First Development (NON-NEGOTIABLE)

Tests MUST be written before implementation code. The workflow is:

1. Write an integration test that captures expected AWS behavior
2. Run the test against real AWS to record correct snapshots
3. Confirm the test fails against LocalStack (expected — feature not yet implemented)
4. Implement the feature in LocalStack
5. Run the test against LocalStack to confirm it passes

A task that includes writing tests MUST NOT be marked complete until the test
exists, runs, and produces the expected result (pass against AWS, fail against
LocalStack pre-implementation). An implementation task MUST NOT be marked
complete until an existing test passes against LocalStack.

**Rationale**: LocalStack's value depends on AWS-faithful behavior. Tests
derived from real AWS responses are the single source of truth.

### II. AWS Parity Testing

All new or modified tests MUST be validated against real AWS before being
trusted. The canonical command is:

```bash
AWS_PROFILE=ls-sandbox TEST_TARGET=AWS_CLOUD SNAPSHOT_UPDATE=1 pytest <path> -v
```

- `AWS_PROFILE=ls-sandbox` — uses the shared sandbox AWS account
- `TEST_TARGET=AWS_CLOUD` — routes requests to real AWS
- `SNAPSHOT_UPDATE=1` — records/updates snapshot files from AWS responses

Tests MUST use the `@markers.aws.validated` decorator. Tests that only run
against LocalStack MUST use `@markers.aws.only_localstack` and are reserved
for implementation-specific assertions that have no AWS equivalent.

**Rationale**: Snapshot files generated from AWS responses are the ground truth
for parity. Running against AWS ensures tests reflect actual service behavior.

### III. Snapshot Integrity

- `*.snapshot.json` and `*.validation.json` files MUST NEVER be edited manually
- These files are auto-generated by running tests with `SNAPSHOT_UPDATE=1`
  against AWS
- If a task involves recording a snapshot, the task MUST NOT be marked complete
  unless the snapshot was actually recorded (file created or updated on disk)
- Use `snapshot.match()` for all assertions — plain `assert` is forbidden in
  validated tests
- Add snapshot transformers before `snapshot.match()` for non-deterministic
  values (ARNs, timestamps, request IDs)

**Rationale**: Manual edits to snapshot files introduce drift from real AWS
behavior and silently break parity guarantees.

### IV. LocalStack Verification (NON-NEGOTIABLE)

Implementation work MUST NOT be marked complete unless an existing test has
been run successfully against LocalStack. The verification steps are:

1. Start LocalStack using the development runner (see Principle V)
2. Run the relevant test(s) with `pytest <path> -v` (no `TEST_TARGET` — defaults to LocalStack)
3. Confirm all assertions and snapshot matches pass

If a test fails against LocalStack, the implementation is incomplete. Do not
mark the task as done — investigate and fix until the test passes.

**Rationale**: The only proof that an implementation is correct is a passing
test against the running LocalStack instance with local code changes mounted.

### V. Development Environment

To run tests against LocalStack with local code changes, LocalStack MUST be
started using:

```bash
python -m localstack.dev.run
```

This command MUST be run from the project's `.venv` virtual environment. It
mounts local source code into the Docker container so that code changes are
reflected immediately.

- `localstack start` runs the pre-built Docker image WITHOUT local changes —
  MUST NOT be used for development verification
- The `.venv` virtual environment contains all required dependencies including
  `ruff` at `.venv/bin/ruff`

#### LocalStack Lifecycle Management

Every LocalStack test run MUST follow this exact 5-step sequence:

**Step 1 — Verify stopped before starting:**

```bash
localstack status
```

Confirm runtime status is `stopped` in the output. Do NOT proceed to
Step 2 if LocalStack is already running — run `localstack stop` first and
re-check.

**Step 2 — Start LocalStack:**

```bash
python -m localstack.dev.run
```

Run from the project's `.venv`. This mounts local source code into the
container.

**Step 3 — Verify running:**

```bash
localstack status
```

Confirm runtime status is `running` in the output. Do NOT proceed to
run tests until this is confirmed.

**Step 4 — Stop LocalStack after tests:**

```bash
localstack stop
```

MUST be run after every test session completes, regardless of pass/fail.

**Step 5 — Verify stopped before proceeding:**

```bash
localstack status
```

Confirm runtime status is `stopped` in the output. Do NOT proceed to
the next task until shutdown is confirmed.

**Rationale**: Using the wrong start command means tests run against stale
code, producing misleading results. Verifying stopped state before start
prevents port conflicts and stale container state. Stopping after tests
prevents resource leaks.

### VI. Resource Safety

- MUST use fixtures for all AWS resource creation — never create resources
  directly in test bodies
- MUST use `account_id` and `region_name` fixtures — never hardcode
  `123456789012` or `us-east-1`
- MUST NOT modify files in `aws/api/` — these are auto-generated from AWS API
  definitions
- MUST NOT add project dependencies without explicit approval
- MUST NOT run `git push` or modify repository history without explicit approval

**Rationale**: Hardcoded values cause test failures across accounts/regions.
Auto-generated files will be overwritten and manual changes lost.

### VII. Simplicity

- Start with the simplest correct implementation (CRUD first, then edge cases)
- Prefer integration tests over unit tests
- Follow patterns in nearby existing code before inventing new patterns
- Use type hints and concise Sphinx docstrings
- Avoid over-commenting tests — test names and structure should be
  self-explanatory

**Rationale**: LocalStack's codebase is large. Consistency with existing
patterns reduces cognitive load and review friction.

## Hard Constraints

The following actions are unconditionally forbidden:

| Action | Reason |
|--------|--------|
| Edit `*.snapshot.json` / `*.validation.json` manually | Auto-generated from AWS |
| Use plain `assert` in validated tests | MUST use `snapshot.match()` |
| Create AWS resources directly in test bodies | MUST use fixtures |
| Hardcode account IDs or region names | MUST use fixtures |
| Modify files in `aws/api/` | Auto-generated from AWS API definitions |
| Add dependencies without approval | Dependency governance |
| Run `git push` or modify repo history | Requires explicit approval |

## Development Workflow

The standard development cycle for any feature or fix:

1. **Write a failing test** — capture expected AWS behavior using
   `@markers.aws.validated` and `snapshot.match()`
2. **Run against AWS** — `AWS_PROFILE=ls-sandbox TEST_TARGET=AWS_CLOUD SNAPSHOT_UPDATE=1 pytest <path> -v`
3. **Verify snapshots recorded** — confirm `*.snapshot.json` files were
   created/updated
4. **Find the provider** — locate `services/<service>/provider.py`
5. **Implement** — follow existing patterns, check `models.py` for state
6. **Verify stopped** — `localstack status` must show runtime status
   `"stopped"` (if running, `localstack stop` first)
7. **Start LocalStack** — `python -m localstack.dev.run` (from `.venv`)
8. **Verify running** — `localstack status` must show runtime status
   `"running"`
9. **Run against LocalStack** — `pytest <path> -v` (no `TEST_TARGET`)
10. **Confirm pass** — all snapshot matches green before marking complete
11. **Stop LocalStack** — `localstack stop`, then `localstack status` must
    show runtime status `"stopped"` before proceeding

Reference implementations:
- **Provider patterns**: CodeBuild service (`localstack-pro-core/.../codebuild/provider.py`)
- **Test patterns**: Pipes tests (`localstack-pro-core/.../pipes/test_pipes_validation.py`)
- **Fixture patterns**: Pipes conftest (`localstack-pro-core/.../pipes/conftest.py`)

## Governance

This constitution supersedes all ad-hoc practices. All work MUST comply with
these principles. Specifically:

- **Task completion gates**: Tasks involving tests MUST NOT be marked complete
  without recorded snapshots. Tasks involving implementation MUST NOT be marked
  complete without a passing LocalStack test run.
- **Amendments**: Changes to this constitution require documentation of the
  change, rationale, and version bump. Use semantic versioning:
  - MAJOR: Principle removed or redefined incompatibly
  - MINOR: New principle or materially expanded guidance
  - PATCH: Clarifications, wording, typo fixes
- **Compliance review**: Every task checkpoint should verify adherence to
  the relevant principles before proceeding.

Use `AGENTS.md` at the repository root as the runtime development guidance
reference.

**Version**: 1.1.0 | **Ratified**: 2026-02-24 | **Last Amended**: 2026-02-24
