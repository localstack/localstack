# Implementation Plan: Native IAM Provider

**Branch**: `001-iam-native-provider` | **Date**: 2025-12-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-iam-native-provider/spec.md`

## Summary

Replace the moto-dependent IAM implementation with a native LocalStack provider following the `AccountRegionBundle` pattern. This migration will:
- Remove all moto imports from the IAM service
- Implement 164 IAM API operations natively
- Maintain full AWS parity with existing tests
- Enable better control over IAM behavior and easier debugging

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: LocalStack core (stores, plugins, aws.api)
**Storage**: In-memory with AccountRegionBundle persistence support
**Testing**: pytest with AWS-validated snapshot testing
**Target Platform**: LocalStack container (Linux)
**Project Type**: Single project (localstack-core)
**Performance Goals**: No regression from current moto-based implementation (<10% latency increase)
**Constraints**: Must pass all existing IAM tests, zero moto imports remaining
**Scale/Scope**: 164 API operations, 13 entity types, ~15,000-20,000 lines of code

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Provider Pattern | PASS | Will inherit from `IamApi`, implement `ServiceLifecycleHook` |
| II. State Management (AccountRegionBundle) | PASS | Using `IamStore` with `CrossRegionAttribute` for global IAM semantics |
| III. API Auto-Generation | PASS | Using existing generated `localstack.aws.api.iam` types |
| IV. Moto Integration | N/A | Goal is to REMOVE moto dependency |
| V. Parity Testing | PASS | Will use `@markers.aws.validated` and snapshot testing |
| VI. Fixture-Based Resource Management | PASS | Using existing `create_user`, `create_role`, `create_policy` fixtures |
| VII. Dynamic Value Handling | PASS | Using `short_uid()` for IDs, fixtures for account/region |
| VIII. Service Lifecycle Hooks | PASS | Implementing `accept_state_visitor`, `on_after_state_load`, etc. |
| IX. Error Handling | PASS | Using generated exceptions from `localstack.aws.api.iam` |
| X. Code Conventions | PASS | Following SNS reference implementation patterns |

**Gate Result**: PASS - All applicable principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/001-iam-native-provider/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research output
├── data-model.md        # Entity definitions
├── quickstart.md        # Developer guide
├── contracts/           # API contracts
│   └── iam-api-operations.md
├── tasks.md             # Generated by /speckit.tasks
└── checklists/
    └── requirements.md  # Spec quality checklist
```

### Source Code (repository root)

```text
localstack-core/localstack/services/iam/
├── __init__.py              # Package init
├── models.py                # NEW: Data models + IamStore
├── provider.py              # MODIFY: Replace moto with native
├── aws_managed_policies.json # NEW: AWS managed policy data
├── service_linked_roles.py  # NEW: Service-linked role definitions
└── resource_providers/      # UPDATE: Use native provider
    ├── aws_iam_accesskey.py
    ├── aws_iam_group.py
    ├── aws_iam_instanceprofile.py
    ├── aws_iam_managedpolicy.py
    ├── aws_iam_policy.py
    ├── aws_iam_role.py
    ├── aws_iam_samlprovider.py
    ├── aws_iam_servercertificate.py
    ├── aws_iam_servicelinkedrole.py
    └── aws_iam_user.py

tests/aws/services/iam/
├── test_iam.py              # UPDATE: Add new tests
├── test_iam.snapshot.json   # UPDATE: New snapshots
└── test_iam.validation.json # UPDATE: Validation data
```

**Structure Decision**: Using existing LocalStack service structure. New files (`models.py`, `aws_managed_policies.json`, `service_linked_roles.py`) follow patterns from S3 and Lambda services.

## Complexity Tracking

> No constitution violations requiring justification.

## Implementation Phases

### Phase 1: Core Infrastructure (P1 Operations)

**Goal**: Create store, models, and implement core CRUD operations

**Files to Create**:
- `localstack/services/iam/models.py` - All data models + IamStore

**Files to Modify**:
- `localstack/services/iam/provider.py` - Begin native implementation

**Operations (67 total)**:
- User: CreateUser, GetUser, ListUsers, UpdateUser, DeleteUser
- Role: CreateRole, GetRole, ListRoles, DeleteRole
- Group: CreateGroup, GetGroup, ListGroups, UpdateGroup, DeleteGroup
- Policy: CreatePolicy, GetPolicy, ListPolicies, DeletePolicy
- Inline Policies: Put/Get/Delete/List for User, Role, Group
- Attachments: Attach/Detach/List for User, Role, Group
- Policy Versions: Create, Delete, Get, List, SetDefault
- Access Keys: Create, Delete, List, Update, GetLastUsed
- Group Membership: AddUserToGroup, RemoveUserFromGroup, ListGroupsForUser

### Phase 2: Extended Resources (P2 Operations)

**Goal**: Implement instance profiles, service-linked roles, boundaries

**Files to Create**:
- `localstack/services/iam/service_linked_roles.py` - Migrate definitions

**Operations (35 total)**:
- Instance Profiles: Create, Delete, Get, List, AddRole, RemoveRole, Tags
- Service-Linked Roles: Create, Delete, GetDeletionStatus
- Permission Boundaries: Put/Delete for User and Role
- Service-Specific Credentials: Create, Delete, List, Update, Reset
- Login Profiles: Create, Delete, Get, Update
- Tags: User, Role, Policy tags

### Phase 3: Advanced Features (P3 Operations)

**Goal**: Complete all remaining operations

**Files to Create**:
- `localstack/services/iam/aws_managed_policies.json` - Policy data

**Operations (62 total)**:
- MFA: Create, Delete, Enable, Deactivate, Resync, List, Tags
- OIDC: Create, Delete, Get, List, AddClientID, RemoveClientID, UpdateThumbprint, Tags
- SAML: Create, Delete, Get, List, Update, Tags
- Certificates: Upload, Delete, Get, List, Update, Tags
- SSH Keys: Upload, Delete, Get, Update, List
- Signing Certs: Upload, Delete, Update, List
- Account: Alias, Password Policy, Summary, Credential Report
- Policy Simulation: SimulateCustomPolicy, SimulatePrincipalPolicy, etc.
- Organizations: Root credentials, sessions, reports

### Phase 4: Integration & Cleanup

**Goal**: Update integrations, remove moto, verify persistence

**Files to Modify**:
- `localstack/services/sts/provider.py` - Use native IAM store
- `localstack/services/s3/presigned_url.py` - Use native access keys
- `localstack/services/iam/resource_providers/*.py` - Update all

**Files to Delete**:
- `localstack/services/iam/iam_patches.py` - No longer needed

**Verification**:
- All existing tests pass
- Persistence works across restarts
- Multi-account isolation complete
- Zero moto imports remain

## Test Strategy

### Existing Tests
- 38 tests in `test_iam.py` with 97% AWS validation
- Must all pass after migration

### New Tests Required
- One test per new operation added
- Focus on operations currently delegated to moto
- Edge cases for validation and error handling

### Test Command
```bash
# Run IAM tests
pytest tests/aws/services/iam/test_iam.py -v

# Update snapshots from AWS
TEST_TARGET=AWS_CLOUD SNAPSHOT_UPDATE=1 pytest tests/aws/services/iam/test_iam.py -v
```

## Dependencies

### Internal Dependencies
| Module | Purpose |
|--------|---------|
| `localstack.services.stores` | AccountRegionBundle, BaseStore |
| `localstack.services.plugins` | ServiceLifecycleHook |
| `localstack.aws.api.iam` | Generated types and exceptions |
| `localstack.utils.tagging` | TaggingService |
| `localstack.utils.strings` | short_uid |
| `localstack.state` | StateVisitor |

### External Dependencies
None required - fully native implementation.

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing tests | High | Incremental migration with test verification at each step |
| Regression in behavior | High | AWS parity testing with snapshots |
| Performance degradation | Medium | Benchmark before/after, optimize if needed |
| Missing edge cases | Medium | Migrate existing moto patches as tests |
| STS integration issues | High | Test AssumeRole thoroughly |

## Artifacts Generated

| File | Description |
|------|-------------|
| `research.md` | Technical decisions and rationale |
| `data-model.md` | Entity definitions and relationships |
| `contracts/iam-api-operations.md` | All 164 operations with priorities |
| `quickstart.md` | Developer implementation guide |

## Next Steps

Run `/speckit.tasks` to generate detailed task breakdown with dependencies.
