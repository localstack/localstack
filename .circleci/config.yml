version: 2.1

jobs:
  install:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - run:
          command: |
            sudo apt-get update
            sudo apt install -y python3.8 libsasl2-dev
          name: Install prerequisites
      - run:
          command: virtualenv --python=`which python3.8` .venv; make ci-build-prepare
          name: Setup environment
  preflight:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "preflight: $(pwd)"
            ls -la .
  unit-tests:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "unit-tests: $(pwd)"
            sleep 2
            ls -la .
  integration-tests:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "integration-tests: $(pwd)"
            sleep 5
            ls -la .
  docker-build:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "docker-build: $(pwd)"
            sleep 10
            ls -la .
  docker-push:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "docker-push: $(pwd)"
            ls -la .

workflows:
  main:
    jobs:
      - install
      - preflight:
          requires:
            - install
      - unit-tests:
          requires:
            - preflight
      - integration-tests:
          requires:
            - preflight
      - docker-build:
          requires:
            - preflight
      - docker-push:
          requires:
            - unit-tests
            - integration-tests
            - docker-build
