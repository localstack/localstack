version: 2.1

jobs:
  install:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace
    steps:
      - run:
          command: |
            pwd
            ls -la .
      - checkout
      - restore_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
      - run:
          command: |
            sudo apt-get update
            sudo apt install -y python3.8 libsasl2-dev
          name: Install prerequisites
      - run:
          command: |
            python3 -m venv .venv
            source .venv/bin/activate
            pip3 install -r requirements.txt
            ls -la ~/.cache/pip
          name: Setup environment
      - save_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
          paths:
            - "~/.cache/pip"
      - persist_to_workspace:
          root:
            /tmp/workspace
          paths:
            - localstack
  preflight:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace
    steps:
      - attach_workspace:
          # Must be absolute path or relative path from working_directory
          at: localstack
      - run:
          command: |
            echo "preflight: $(pwd)"
            python3 --version
            ls -la .
  unit-tests:
    docker:
      - image: buildpack-deps:focal
    steps:
      - run:
          command: |
            echo "unit-tests: $(pwd)"
            sleep 2
            ls -la .
  integration-tests:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "integration-tests: $(pwd)"
            sleep 5
            ls -la .
  docker-build:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "docker-build: $(pwd)"
            sleep 10
            ls -la .
  docker-push:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          command: |
            echo "docker-push: $(pwd)"
            ls -la .

workflows:
  main:
    jobs:
      - install
      - preflight:
          requires:
            - install
      - unit-tests:
          requires:
            - preflight
      - integration-tests:
          requires:
            - preflight
      - docker-build:
          requires:
            - preflight
      - docker-push:
          filters:
            branches:
              only: main
          requires:
            - unit-tests
            - integration-tests
            - docker-build
