version: 2.1

jobs:
  install:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace/repo
    steps:
      - checkout
      - run:
          command: |
            pwd
            ls -la .
      - restore_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
      - run:
          command: |
            sudo apt-get update
            sudo apt install -y libsasl2-dev
          name: Install prerequisites
      - run:
          command: |
            python3 -m venv .venv
            source .venv/bin/activate
            pip install wheel
            pip install -r requirements.txt
          name: Setup environment
      - save_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
          paths:
            - "~/.cache/pip"
      - persist_to_workspace:
          root:
            /tmp/workspace
          paths:
            - repo

  preflight:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: make lint

  unit-tests:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: DEBUG=0 TEST_PATH=tests/unit make test

  integration-tests:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            echo "integration-tests: $(pwd)"
            sleep 5
            ls -la .

  docker-build:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            echo "docker-build: $(pwd)"
            sleep 10
            ls -la .

  docker-push:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            echo "docker-push: $(pwd)"
            ls -la .

workflows:
  main:
    jobs:
      - install
      - preflight:
          requires:
            - install
      - unit-tests:
          requires:
            - preflight
      - integration-tests:
          requires:
            - preflight
      - docker-build:
          requires:
            - preflight
      - docker-push:
          filters:
            branches:
              only: main
          requires:
            - unit-tests
            - integration-tests
            - docker-build
