version: 2.1

jobs:
  install:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - checkout
      - restore_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
      - run:
          command: |
            sudo apt-get update
            sudo apt-get install -y libsasl2-dev python3.8-venv python3.8-dev
          name: Install prerequisites
      - run:
          command: |
            /usr/bin/python3.8 -m venv .venv
            source .venv/bin/activate
            which python
            realpath $(which python)
            pip install --upgrade pip
            pip install wheel setuptools pytest
            pip install -r requirements.txt
            python -m localstack.services.install libs
            python -m localstack.services.install testlibs
          name: Setup environment
      - save_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
          paths:
            - "~/.cache/pip"
      - persist_to_workspace:
          root:
            /tmp/workspace
          paths:
            - repo

  preflight:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: make lint
          name: run linter
      - run:
          command: |
            source .venv/bin/activate
            pytest tests/unit --junitxml=target/tests/TESTS-unit.xml -o junit_suite_name=unit-tests
          name: run unit tests
      - store_test_results:
          path: target/tests/

  itest-lambda-docker:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            make ci-build-prepare
            mkdir -p target/reports
          name: preparing ci tests
      - run:
          command: docker image ls
      - run:
          name: test docker executor
          environment:
            DEUBG: 1
            LAMBDA_EXECUTOR: "docker"
            USE_SSL: 1
            TEST_ERROR_INJECTION: 1
            TEST_PATH: "tests/integration/test_lambda.py tests/integration/test_integration.py"
            NOSE_ARGS: "--with-xunit --xunit-testsuite-name='lambda-docker' --xunit-file=target/reports/lambda-docker.xml"
          command: make test
      - run:
          name: test docker-reuse executor
          environment:
            LAMBDA_EXECUTOR: "docker-reuse"
            TEST_PATH: "tests/integration/test_lambda.py tests/integration/test_integration.py"
            NOSE_ARGS: "--with-xunit --xunit-testsuite-name='lambda-docker-reuse' --xunit-file=target/reports/lambda-docker-reuse.xml"
          command: make test
      - store_test_results:
          path: target/reports/

  itest-elasticmq:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: test elasticmq sqs provider
          environment:
            DEBUG: 1
            SQS_PROVIDER: "elasticmq"
            TEST_PATH: "tests/integration/test_sns.py:SNSTest.test_publish_sqs_from_sns_with_xray_propagation"
            NOSE_ARGS: "--with-xunit --xunit-testsuite-name='elasticmq' --xunit-file=target/reports/elasticmq.xml"
          command:  make test
      - store_test_results:
          path: target/reports/

  docker-build:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: docker image ls
      - run:
          command: make init
          name: Initialize build environment
      - run:
          command: make docker-build
          name: Build localstack docker image


  docker-push:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            echo "docker-push: $(pwd)"
            ls -la .
            docker image ls

workflows:
  main:
    jobs:
      - install
      - preflight:
          requires:
            - install
      - itest-lambda-docker:
          requires:
            - preflight
      - itest-elasticmq:
          requires:
            - preflight
      - docker-build:
          requires:
            - preflight
      - docker-push:
          # filters:
          #   branches:
          #     only: main
          requires:
            - itest-lambda-docker
            - itest-elasticmq
            - docker-build
