version: 2.1

jobs:
  install:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - checkout
      - restore_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
      - run:
          command: |
            sudo apt-get update
            sudo apt-get install -y libsasl2-dev python3.8-venv python3.8-dev
          name: Install prerequisites
      - run:
          command: |
            /usr/bin/python3.8 -m venv .venv
            source .venv/bin/activate
            which python
            realpath $(which python)
            pip install --upgrade pip
            pip install wheel setuptools pytest
            pip install -r requirements.txt
            python -m localstack.services.install libs
            python -m localstack.services.install testlibs
          name: Setup environment
      - save_cache:
          key: python-requirements-{{ checksum "requirements.txt" }}
          paths:
            - "~/.cache/pip"
      - persist_to_workspace:
          root:
            /tmp/workspace
          paths:
            - repo

  preflight:
    docker:
      - image: buildpack-deps:focal
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: make lint
          name: run linter
      - run:
          command: |
            source .venv/bin/activate
            pytest tests/unit --junitxml=target/tests/TESTS-unit.xml -o junit_suite_name=unit-tests
          name: run unit tests
      - store_test_results:
          path: target/tests/

  itest-lambda-docker:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace

      - run:
          command: |
            make init
            docker pull lambci/lambda:20191117-nodejs8.10
            docker pull lambci/lambda:20191117-ruby2.5
            docker pull lambci/lambda:20210129-ruby2.7
            docker pull lambci/lambda:20191117-python2.7
            docker pull lambci/lambda:20191117-python3.6
            docker pull lambci/lambda:20191117-dotnetcore2.0
            docker pull lambci/lambda:dotnetcore3.1
            docker pull lambci/lambda:20191117-provided
            docker pull lambci/lambda:java8
            docker pull lambci/lambda:python3.8
          name: pull lambda runtimes
      - run:
          command: docker image ls
      - run:
          command: DEBUG=1 LAMBDA_EXECUTOR=docker USE_SSL=1 TEST_ERROR_INJECTION=1 TEST_PATH="tests/integration/test_lambda.py tests/integration/test_integration.py" make test
          name: test docker executor
      - run:
          command: LAMBDA_EXECUTOR=docker-reuse TEST_PATH="tests/integration/test_lambda.py tests/integration/test_integration.py" make test
          name: test docker-reuse executor

  itest-elasticmq:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: DEBUG=1 SQS_PROVIDER=elasticmq TEST_PATH="tests/integration/test_sns.py:SNSTest.test_publish_sqs_from_sns_with_xray_propagation" make test
          name: test elasticmq sqs provider

  docker-build:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: docker image ls
      - run:
          command: make init
          name: Initialize build environment
      - run:
          command: make docker-build
          name: Build localstack docker image


  docker-push:
    machine:
      image: ubuntu-2004:202101-01
    working_directory: /tmp/workspace/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          command: |
            echo "docker-push: $(pwd)"
            ls -la .
            docker image ls

workflows:
  main:
    jobs:
      - install
      - preflight:
          requires:
            - install
      - itest-lambda-docker:
          requires:
            - preflight
      - itest-elasticmq:
          requires:
            - preflight
      - docker-build:
          requires:
            - preflight
      - docker-push:
          # filters:
          #   branches:
          #     only: main
          requires:
            - itest-lambda-docker
            - itest-elasticmq
            - docker-build
